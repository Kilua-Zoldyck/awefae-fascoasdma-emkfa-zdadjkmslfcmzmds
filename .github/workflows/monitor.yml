name: FTTH Ticket Monitor

on:
  # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚ (+ ØªØ£Ø®ÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ 30 Ø«Ø§Ù†ÙŠØ© - 6 Ø¯Ù‚Ø§Ø¦Ù‚)
  schedule:
    - cron: '*/10 * * * *'
  
  # Trigger from Airflow
  repository_dispatch:
    types: [trigger-monitor]
  
  workflow_dispatch:

env:
  GITHUB_ACTIONS: 'true'

concurrency:
  group: ftth-monitor-main
  cancel-in-progress: true  # Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠÙ„ØºÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ø´Ø§Ù† Ù…ÙŠØªØ²Ø§Ø­Ù…ÙˆØ´

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ùˆ GitHub Ø¹Ù†Ø¯Ù‡ Ù…Ø´Ø§ÙƒÙ„
    strategy:
      fail-fast: false
      max-parallel: 1
    
    # Grant Write Access for Git Push
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Dependencies
        run: |
          pip install -q python-dotenv playwright aiohttp python-telegram-bot
          playwright install chromium
          playwright install-deps chromium

      - name: ðŸ” Check for fresh state
        id: check_state
        run: |
          if [ -f browser_state.json ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "âœ… Using fresh state from repository"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No repo state, will use artifact"
          fi

      - name: ðŸ“‚ Download state
        if: steps.check_state.outputs.found != 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: monitor.yml
          name: ftth-state
          path: .
          if_no_artifact_found: warn

      - name: ðŸ” Run monitor & Bot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          GROUP_CHAT_ID: ${{ secrets.GROUP_CHAT_ID }}
          DEV_CHAT_ID: ${{ secrets.DEV_CHAT_ID }}
          FTTH_USERNAME: ${{ secrets.FTTH_USERNAME }}
          FTTH_PASSWORD: ${{ secrets.FTTH_PASSWORD }}
          WHATSAPP_TOKEN: ${{ secrets.WHATSAPP_TOKEN }}
          WHATSAPP_PHONE_ID: ${{ secrets.WHATSAPP_PHONE_ID }}
          WHATSAPP_RECIPIENT: ${{ secrets.WHATSAPP_RECIPIENT }}
        run: |
          # Start Settings Bot in Background (Interactive Control)
          nohup python settings_bot.py > bot.log 2>&1 &
          
          # Run Main Monitor
          python monitor.py

      - name: ðŸ’¾ Save state
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ftth-state
          path: |
            known_tickets.json
            known_subscriptions.json
            browser_state.json
          retention-days: 90
          overwrite: true

  # Keep-Alive: Ù…Ù†Ø¹ GitHub Ù…Ù† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€ workflow Ø¨Ø¹Ø¯ 60 ÙŠÙˆÙ…
  keep-alive:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: monitor
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”„ Keep workflow alive
        run: |
          day=$(date +%d)
          if [ "$day" = "01" ] || [ "$day" = "15" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            mkdir -p .github
            echo "Last keep-alive: $(date -u)" > .github/.keep-alive
            
            git add .github/.keep-alive
            git diff --staged --quiet || git commit -m "ðŸ¤– Keep workflow alive [skip ci]"
            git push || true
          fi
