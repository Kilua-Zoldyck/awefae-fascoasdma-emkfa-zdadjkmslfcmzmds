name: FTTH Ticket Monitor

on:
  # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚ (+ ØªØ£Ø®ÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ 30 Ø«Ø§Ù†ÙŠØ© - 6 Ø¯Ù‚Ø§Ø¦Ù‚)
  schedule:
    - cron: '*/10 * * * *'
  
  workflow_dispatch:

env:
  GITHUB_ACTIONS: 'true'

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Dependencies
        run: |
          pip install -q python-dotenv playwright aiohttp
          playwright install chromium
          playwright install-deps chromium

      - name: ðŸ“‚ Download state
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ftth-state
          path: .

      - name: ðŸ” Run monitor
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
        run: python monitor.py

      - name: ðŸ’¾ Save state
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ftth-state
          path: |
            known_tickets.json
            browser_state.json
          retention-days: 90
          overwrite: true

  # Keep-Alive: Ù…Ù†Ø¹ GitHub Ù…Ù† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€ workflow Ø¨Ø¹Ø¯ 60 ÙŠÙˆÙ…
  keep-alive:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: monitor
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”„ Keep workflow alive
        run: |
          day=$(date +%d)
          if [ "$day" = "01" ] || [ "$day" = "15" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            mkdir -p .github
            echo "Last keep-alive: $(date -u)" > .github/.keep-alive
            
            git add .github/.keep-alive
            git diff --staged --quiet || git commit -m "ðŸ¤– Keep workflow alive [skip ci]"
            git push || true
          fi
